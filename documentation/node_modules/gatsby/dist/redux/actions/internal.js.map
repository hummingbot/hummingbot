{"version":3,"sources":["../../../src/redux/actions/internal.ts"],"names":["createPageDependency","path","nodeId","connection","plugin","type","payload","deleteComponentsDependencies","paths","replaceComponentQuery","query","componentPath","replaceStaticQuery","args","queryExtracted","traceId","setGraphQLDefinitions","definitionsByName","queryExtractionGraphQLError","error","queryExtractedBabelSuccess","queryExtractionBabelError","setProgramStatus","status","pageQueryRun","isPage","removeStaleJob","contentDigest","setSiteConfig","config","result","gatsbyConfigSchema","validate","normalizedPayload","value","hasUnknownKeys","details","filter","Array","isArray","length","errorMessages","map","unknown","context","message","key","suggestion","reporter","panic","id","sourceMessage","join"],"mappings":"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","sourcesContent":["import reporter from \"gatsby-cli/lib/reporter\"\n\nimport {\n  IGatsbyConfig,\n  IGatsbyPlugin,\n  ProgramStatus,\n  ICreatePageDependencyAction,\n  IDeleteComponentDependenciesAction,\n  IReplaceComponentQueryAction,\n  IReplaceStaticQueryAction,\n  IQueryExtractedAction,\n  IQueryExtractionGraphQLErrorAction,\n  IQueryExtractedBabelSuccessAction,\n  IQueryExtractionBabelErrorAction,\n  ISetProgramStatusAction,\n  IPageQueryRunAction,\n  IRemoveStaleJobAction,\n  ISetSiteConfig,\n  IDefinitionMeta,\n  ISetGraphQLDefinitionsAction,\n} from \"../types\"\n\nimport { gatsbyConfigSchema } from \"../../joi-schemas/joi\"\nimport { didYouMean } from \"../../utils/did-you-mean\"\n\n/**\n * Create a dependency between a page and data. Probably for\n * internal use only.\n * @private\n */\nexport const createPageDependency = (\n  {\n    path,\n    nodeId,\n    connection,\n  }: { path: string; nodeId?: string; connection?: string },\n  plugin = ``\n): ICreatePageDependencyAction => {\n  return {\n    type: `CREATE_COMPONENT_DEPENDENCY`,\n    plugin,\n    payload: {\n      path,\n      nodeId,\n      connection,\n    },\n  }\n}\n\n/**\n * Delete dependencies between an array of pages and data. Probably for\n * internal use only. Used when deleting pages.\n * @private\n */\nexport const deleteComponentsDependencies = (\n  paths: Array<string>\n): IDeleteComponentDependenciesAction => {\n  return {\n    type: `DELETE_COMPONENTS_DEPENDENCIES`,\n    payload: {\n      paths,\n    },\n  }\n}\n\n/**\n * When the query watcher extracts a GraphQL query, it calls\n * this to store the query with its component.\n * @private\n */\nexport const replaceComponentQuery = ({\n  query,\n  componentPath,\n}: {\n  query: string\n  componentPath: string\n}): IReplaceComponentQueryAction => {\n  return {\n    type: `REPLACE_COMPONENT_QUERY`,\n    payload: {\n      query,\n      componentPath,\n    },\n  }\n}\n\n/**\n * When the query watcher extracts a \"static\" GraphQL query from <StaticQuery>\n * components, it calls this to store the query with its component.\n * @private\n */\nexport const replaceStaticQuery = (\n  args: any,\n  plugin: IGatsbyPlugin | null | undefined = null\n): IReplaceStaticQueryAction => {\n  return {\n    type: `REPLACE_STATIC_QUERY`,\n    plugin,\n    payload: args,\n  }\n}\n\n/**\n *\n * Report that a query has been extracted from a component. Used by\n * query-compiler.js.\n * @private\n */\nexport const queryExtracted = (\n  { componentPath, query }: { componentPath: string; query: string },\n  plugin: IGatsbyPlugin,\n  traceId?: string\n): IQueryExtractedAction => {\n  return {\n    type: `QUERY_EXTRACTED`,\n    plugin,\n    traceId,\n    payload: { componentPath, query },\n  }\n}\n\n/**\n * Set Definitions for fragment extraction, etc.\n *\n * Used by developer tools such as vscode-graphql & graphiql\n *\n * query-compiler.js.\n * @private\n */\nexport const setGraphQLDefinitions = (\n  definitionsByName: Map<string, IDefinitionMeta>\n): ISetGraphQLDefinitionsAction => {\n  return {\n    type: `SET_GRAPHQL_DEFINITIONS`,\n    payload: definitionsByName,\n  }\n}\n\n/**\n *\n * Report that the Relay Compiler found a graphql error when attempting to extract a query\n * @private\n */\nexport const queryExtractionGraphQLError = (\n  { componentPath, error }: { componentPath: string; error: string },\n  plugin: IGatsbyPlugin,\n  traceId?: string\n): IQueryExtractionGraphQLErrorAction => {\n  return {\n    type: `QUERY_EXTRACTION_GRAPHQL_ERROR`,\n    plugin,\n    traceId,\n    payload: { componentPath, error },\n  }\n}\n\n/**\n *\n * Report that babel was able to extract the graphql query.\n * Indicates that the file is free of JS errors.\n * @private\n */\nexport const queryExtractedBabelSuccess = (\n  { componentPath },\n  plugin: IGatsbyPlugin,\n  traceId?: string\n): IQueryExtractedBabelSuccessAction => {\n  return {\n    type: `QUERY_EXTRACTION_BABEL_SUCCESS`,\n    plugin,\n    traceId,\n    payload: { componentPath },\n  }\n}\n\n/**\n *\n * Report that the Relay Compiler found a babel error when attempting to extract a query\n * @private\n */\nexport const queryExtractionBabelError = (\n  { componentPath, error }: { componentPath: string; error: Error },\n  plugin: IGatsbyPlugin,\n  traceId?: string\n): IQueryExtractionBabelErrorAction => {\n  return {\n    type: `QUERY_EXTRACTION_BABEL_ERROR`,\n    plugin,\n    traceId,\n    payload: { componentPath, error },\n  }\n}\n\n/**\n * Set overall program status e.g. `BOOTSTRAPING` or `BOOTSTRAP_FINISHED`.\n * @private\n */\nexport const setProgramStatus = (\n  status: ProgramStatus,\n  plugin: IGatsbyPlugin,\n  traceId?: string\n): ISetProgramStatusAction => {\n  return {\n    type: `SET_PROGRAM_STATUS`,\n    plugin,\n    traceId,\n    payload: status,\n  }\n}\n\n/**\n * Broadcast that a page's query was run.\n * @private\n */\nexport const pageQueryRun = (\n  { path, componentPath, isPage },\n  plugin: IGatsbyPlugin,\n  traceId?: string\n): IPageQueryRunAction => {\n  return {\n    type: `PAGE_QUERY_RUN`,\n    plugin,\n    traceId,\n    payload: { path, componentPath, isPage },\n  }\n}\n\n/**\n * Remove jobs which are marked as stale (inputPath doesn't exists)\n * @private\n */\nexport const removeStaleJob = (\n  contentDigest: string,\n  plugin?: IGatsbyPlugin,\n  traceId?: string\n): IRemoveStaleJobAction => {\n  return {\n    type: `REMOVE_STALE_JOB_V2`,\n    plugin,\n    traceId,\n    payload: {\n      contentDigest,\n    },\n  }\n}\n\n/**\n * Set gatsby config\n * @private\n */\nexport const setSiteConfig = (config?: unknown): ISetSiteConfig => {\n  const result = gatsbyConfigSchema.validate(config || {})\n  const normalizedPayload: IGatsbyConfig = result.value\n\n  if (result.error) {\n    const hasUnknownKeys = result.error.details.filter(\n      details => details.type === `object.allowUnknown`\n    )\n\n    if (Array.isArray(hasUnknownKeys) && hasUnknownKeys.length) {\n      const errorMessages = hasUnknownKeys.map(unknown => {\n        const { context, message } = unknown\n        const key = context?.key\n        const suggestion = key && didYouMean(key)\n\n        if (suggestion) {\n          return `${message}. ${suggestion}`\n        }\n\n        return message\n      })\n\n      reporter.panic({\n        id: `10122`,\n        context: {\n          sourceMessage: errorMessages.join(`\\n`),\n        },\n      })\n    }\n\n    reporter.panic({\n      id: `10122`,\n      context: {\n        sourceMessage: result.error.message,\n      },\n    })\n  }\n\n  return {\n    type: `SET_SITE_CONFIG`,\n    payload: normalizedPayload,\n  }\n}\n"],"file":"internal.js"}